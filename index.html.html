<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H&K 的美食筆記</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            transition: background-color 0.3s ease;
        }
        .food-card {
            transition: all 0.2s ease;
        }
        .food-card:active {
            transform: scale(0.98);
        }
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .modal-overlay {
            backdrop-filter: blur(4px);
        }
    </style>
</head>
<body class="pb-24 bg-gray-50 dark:bg-zinc-900 text-gray-900 dark:text-zinc-100">

    <!-- Header -->
    <header class="bg-white dark:bg-zinc-800 shadow-sm sticky top-0 z-10 px-4 py-4 transition-colors">
        <div class="max-w-md mx-auto">
            <div class="flex justify-between items-center">
                <h1 class="text-2xl font-bold text-orange-600 flex items-center gap-2">
                    <i class="fas fa-utensils"></i> H&K 的美食筆記
                </h1>
                <div class="flex items-center gap-2">
                    <button onclick="toggleDarkMode()" class="text-gray-500 dark:text-zinc-400 hover:text-orange-600 p-2 text-xl">
                        <i id="themeIcon" class="fas fa-moon"></i>
                    </button>
                    <button onclick="openCategoryManager()" class="text-gray-500 dark:text-zinc-400 hover:text-orange-600 p-2">
                        <i class="fas fa-tags text-xl"></i>
                    </button>
                </div>
            </div>
            
            <!-- 搜尋框 -->
            <div class="mt-4 relative">
                <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                <input type="text" id="searchInput" placeholder="搜尋店名、地址或筆記..." 
                    class="w-full pl-10 pr-4 py-2 bg-gray-100 dark:bg-zinc-700 dark:text-white rounded-xl border-none focus:ring-2 focus:ring-orange-500 outline-none transition">
            </div>

            <!-- 分類標籤列 -->
            <div class="flex gap-2 mt-4 overflow-x-auto no-scrollbar py-1" id="categoryTabs">
                <!-- 由 JS 動態生成 -->
            </div>
        </div>
    </header>

    <!-- 清單內容 -->
    <main class="max-w-md mx-auto p-4 space-y-4" id="foodList">
        <!-- 店家卡片由 JS 動態生成 -->
    </main>

    <!-- 新增按鈕 -->
    <button onclick="openAddModal()" class="fixed bottom-6 right-6 w-14 h-14 bg-orange-600 text-white rounded-full shadow-lg flex items-center justify-center text-2xl z-20 hover:bg-orange-700 transition">
        <i class="fas fa-plus"></i>
    </button>

    <!-- 店家編輯/新增彈窗 -->
    <div id="foodModal" class="fixed inset-0 bg-black/50 hidden z-30 flex items-end sm:items-center justify-center p-0 sm:p-4 modal-overlay">
        <div class="bg-white dark:bg-zinc-800 w-full max-w-md rounded-t-3xl sm:rounded-2xl p-6 shadow-xl">
            <div class="flex justify-between items-center mb-4">
                <h2 id="modalTitle" class="text-xl font-bold text-gray-800 dark:text-zinc-100">新增美食店家</h2>
                <button onclick="closeModal('foodModal')" class="text-gray-400"><i class="fas fa-times"></i></button>
            </div>
            <input type="hidden" id="editId">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-zinc-400">店名</label>
                    <input type="text" id="nameInput" class="w-full mt-1 p-3 bg-gray-50 dark:bg-zinc-700 dark:text-white border-none rounded-xl outline-none focus:ring-2 focus:ring-orange-500">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-zinc-400">分類</label>
                        <select id="typeInput" class="w-full mt-1 p-3 bg-gray-50 dark:bg-zinc-700 dark:text-white border-none rounded-xl outline-none focus:ring-2 focus:ring-orange-500"></select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-zinc-400">評分</label>
                        <select id="ratingInput" class="w-full mt-1 p-3 bg-gray-50 dark:bg-zinc-700 dark:text-white border-none rounded-xl outline-none focus:ring-2 focus:ring-orange-500">
                            <option value="5">⭐⭐⭐⭐⭐</option>
                            <option value="4">⭐⭐⭐⭐</option>
                            <option value="3">⭐⭐⭐</option>
                            <option value="2">⭐⭐</option>
                            <option value="1">⭐</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-zinc-400">地址</label>
                    <input type="text" id="addressInput" class="w-full mt-1 p-3 bg-gray-50 dark:bg-zinc-700 dark:text-white border-none rounded-xl outline-none focus:ring-2 focus:ring-orange-500" placeholder="輸入詳細地址...">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-zinc-400">筆記心得</label>
                    <textarea id="noteInput" rows="3" class="w-full mt-1 p-3 bg-gray-50 dark:bg-zinc-700 dark:text-white border-none rounded-xl outline-none focus:ring-2 focus:ring-orange-500" placeholder="紀錄好吃的菜色..."></textarea>
                </div>
                <button onclick="saveFood()" class="w-full py-4 bg-orange-600 text-white rounded-xl font-bold shadow-md">儲存資訊</button>
            </div>
        </div>
    </div>

    <!-- 分類管理彈窗 -->
    <div id="categoryModal" class="fixed inset-0 bg-black/50 hidden z-40 flex items-center justify-center p-4 modal-overlay">
        <div class="bg-white dark:bg-zinc-800 w-full max-w-xs rounded-2xl p-6 shadow-xl">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-bold dark:text-zinc-100">管理分類</h2>
                <button onclick="closeModal('categoryModal')" class="text-gray-400"><i class="fas fa-times"></i></button>
            </div>
            <div class="space-y-3 mb-4 max-h-60 overflow-y-auto" id="categoryListContainer"></div>
            <div class="flex gap-2 mt-4">
                <input type="text" id="newCatInput" placeholder="新分類名稱" class="flex-1 p-2 bg-gray-50 dark:bg-zinc-700 dark:text-white rounded-lg outline-none text-sm">
                <button onclick="addCategory()" class="px-4 py-2 bg-orange-600 text-white rounded-lg text-sm">新增</button>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-24 left-1/2 -translate-x-1/2 bg-gray-800 dark:bg-orange-600 text-white px-6 py-2 rounded-full text-sm opacity-0 transition-all pointer-events-none z-50"></div>

    <script>
        // 優先從 localStorage 讀取資料
        let foods = JSON.parse(localStorage.getItem('food_notes_data')) || [
            { id: 1, name: "一蘭拉麵", type: "日式", address: "台北市信義區松仁路97號", note: "豚骨湯頭很濃，推薦加辣。", rating: "5", lat: 25.035, lng: 121.567 },
            { id: 2, name: "鼎泰豐", type: "中式", address: "台北市大安區信義路二段194號", note: "小籠包必點。", rating: "5", lat: 25.033, lng: 121.530 }
        ];

        let categories = JSON.parse(localStorage.getItem('food_categories_data')) || ["全部", "中式", "日式", "義式", "甜點", "咖啡廳"];
        
        let currentCategory = '全部';
        let isDarkMode = false;
        let userLocation = null;

        function init() {
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                toggleDarkMode(true);
            }
            getUserLocation();
            refreshUI();
        }

        // 儲存資料到 localStorage
        function saveData() {
            localStorage.setItem('food_notes_data', JSON.stringify(foods));
            localStorage.setItem('food_categories_data', JSON.stringify(categories));
        }

        function getUserLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        showToast('已獲取位置，自動依距離排序');
                        renderFoodList();
                    }
                );
            }
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        function refreshUI() {
            renderCategories();
            renderFoodList();
        }

        function toggleDarkMode(forced = null) {
            isDarkMode = forced !== null ? forced : !isDarkMode;
            const html = document.documentElement;
            const icon = document.getElementById('themeIcon');
            if (isDarkMode) {
                html.classList.add('dark');
                icon.className = 'fas fa-sun';
            } else {
                html.classList.remove('dark');
                icon.className = 'fas fa-moon';
            }
        }

        function renderCategories() {
            const tabs = document.getElementById('categoryTabs');
            tabs.innerHTML = categories.map(cat => `
                <button onclick="filterCategory('${cat}')" 
                    class="cat-btn px-5 py-2 rounded-full whitespace-nowrap text-sm font-medium transition
                    ${currentCategory === cat ? 'bg-orange-600 text-white shadow-md' : 'bg-white dark:bg-zinc-800 text-gray-500 dark:text-zinc-400 border border-gray-100 dark:border-zinc-700'}">
                    ${cat}
                </button>
            `).join('');

            const typeInput = document.getElementById('typeInput');
            if (typeInput) {
                typeInput.innerHTML = categories.filter(c => c !== '全部').map(cat => `
                    <option value="${cat}">${cat}</option>
                `).join('');
            }
        }

        function renderFoodList() {
            const list = document.getElementById('foodList');
            const search = document.getElementById('searchInput').value.toLowerCase();
            
            let filtered = foods.filter(f => {
                const matchesSearch = f.name.toLowerCase().includes(search) || 
                                    f.address.toLowerCase().includes(search) || 
                                    (f.note && f.note.toLowerCase().includes(search));
                const matchesCat = currentCategory === '全部' || f.type === currentCategory;
                return matchesSearch && matchesCat;
            });

            // 排序處理
            if (userLocation) {
                filtered = filtered.map(f => ({
                    ...f,
                    distance: (f.lat && f.lng) ? calculateDistance(userLocation.lat, userLocation.lng, f.lat, f.lng) : 9999
                })).sort((a, b) => a.distance - b.distance);
            } else {
                filtered.sort((a, b) => b.id - a.id);
            }

            if (filtered.length === 0) {
                list.innerHTML = `<div class="text-center py-20 text-gray-400 dark:text-zinc-600"><i class="fas fa-search mb-2 text-4xl block opacity-20"></i>沒有找到相關的紀錄</div>`;
                return;
            }

            list.innerHTML = filtered.map(food => `
                <div class="food-card bg-white dark:bg-zinc-800 p-4 rounded-2xl shadow-sm border border-gray-50 dark:border-zinc-700 flex flex-col gap-3" onclick="openEditModal(${food.id})">
                    <div class="flex justify-between items-start">
                        <div class="flex-1 overflow-hidden">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-[10px] px-2 py-0.5 bg-orange-100 dark:bg-orange-900/30 text-orange-600 dark:text-orange-400 rounded-md font-bold uppercase">${food.type}</span>
                                <span class="text-yellow-400 text-xs">${'⭐'.repeat(parseInt(food.rating))}</span>
                                ${food.distance && food.distance !== 9999 ? `<span class="text-[10px] text-gray-400"><i class="fas fa-walking"></i> ${food.distance.toFixed(1)} km</span>` : ''}
                            </div>
                            <h3 class="text-lg font-bold text-gray-800 dark:text-zinc-100 truncate">${food.name}</h3>
                        </div>
                        <button onclick="event.stopPropagation(); openNav('${food.address}')" class="w-10 h-10 bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 rounded-full flex items-center justify-center">
                            <i class="fas fa-location-arrow"></i>
                        </button>
                    </div>
                    ${food.note ? `<p class="text-gray-500 dark:text-zinc-400 text-sm line-clamp-2 bg-gray-50 dark:bg-zinc-700/50 p-2 rounded-lg italic">「${food.note}」</p>` : ''}
                    <div class="flex justify-between items-center text-[11px] text-gray-400 dark:text-zinc-500 pt-1 border-t border-gray-50 dark:border-zinc-700">
                        <span class="truncate max-w-[80%]"><i class="fas fa-map-marker-alt mr-1"></i>${food.address}</span>
                        <button onclick="event.stopPropagation(); deleteFood(${food.id})" class="text-red-300 hover:text-red-500 p-1 transition-colors">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function openCategoryManager() {
            const container = document.getElementById('categoryListContainer');
            container.innerHTML = categories.filter(c => c !== '全部').map(cat => `
                <div class="flex justify-between items-center p-3 bg-gray-50 dark:bg-zinc-700/50 rounded-xl mb-2">
                    <span class="text-sm font-medium dark:text-zinc-200">${cat}</span>
                    <button onclick="deleteCategory('${cat}')" class="text-red-400 hover:text-red-600 p-1"><i class="fas fa-minus-circle text-lg"></i></button>
                </div>
            `).join('') || `<p class="text-center text-gray-400 py-4 text-sm">目前無自定義分類</p>`;
            document.getElementById('categoryModal').classList.remove('hidden');
        }

        function addCategory() {
            const input = document.getElementById('newCatInput');
            const val = input.value.trim();
            if (val && !categories.includes(val)) {
                categories.push(val);
                input.value = '';
                saveData();
                renderCategories();
                openCategoryManager();
                showToast('分類已新增');
            }
        }

        function deleteCategory(catName) {
            categories = categories.filter(c => c !== catName);
            if (currentCategory === catName) currentCategory = '全部';
            saveData();
            renderCategories();
            openCategoryManager();
            renderFoodList();
            showToast(`已刪除分類: ${catName}`);
        }

        function openAddModal() {
            document.getElementById('modalTitle').innerText = '新增美食店家';
            document.getElementById('editId').value = '';
            document.getElementById('nameInput').value = '';
            document.getElementById('addressInput').value = '';
            document.getElementById('noteInput').value = '';
            document.getElementById('foodModal').classList.remove('hidden');
        }

        function openEditModal(id) {
            const food = foods.find(f => f.id === id);
            if (!food) return;
            document.getElementById('modalTitle').innerText = '編輯店家資訊';
            document.getElementById('editId').value = food.id;
            document.getElementById('nameInput').value = food.name;
            document.getElementById('typeInput').value = food.type;
            document.getElementById('ratingInput').value = food.rating;
            document.getElementById('addressInput').value = food.address;
            document.getElementById('noteInput').value = food.note || '';
            document.getElementById('foodModal').classList.remove('hidden');
        }

        function saveFood() {
            const id = document.getElementById('editId').value;
            const data = {
                name: document.getElementById('nameInput').value.trim(),
                type: document.getElementById('typeInput').value,
                rating: document.getElementById('ratingInput').value,
                address: document.getElementById('addressInput').value.trim(),
                note: document.getElementById('noteInput').value.trim()
            };

            if (!data.name || !data.address) {
                showToast('店名與地址不能空白');
                return;
            }

            if (id) {
                const index = foods.findIndex(f => f.id == id);
                // 保留原本的座標，如果地址沒變的話（模擬邏輯）
                foods[index] = { ...foods[index], ...data };
                showToast('更新成功');
            } else {
                // 模擬新增座標
                const mockLat = 25.04 + (Math.random() - 0.5) * 0.1;
                const mockLng = 121.5 + (Math.random() - 0.5) * 0.1;
                foods.unshift({ id: Date.now(), ...data, lat: mockLat, lng: mockLng });
                showToast('已加入口袋名單');
            }
            
            saveData(); // 儲存到 localStorage
            closeModal('foodModal');
            renderFoodList();
        }

        function deleteFood(id) {
            if (confirm('確定要刪除此店家嗎？')) {
                foods = foods.filter(f => f.id !== id);
                saveData(); // 儲存變更
                renderFoodList();
                showToast('已刪除');
            }
        }

        function openNav(address) {
            window.open(`https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(address)}`, '_blank');
        }

        function filterCategory(cat) {
            currentCategory = cat;
            renderCategories();
            renderFoodList();
        }

        function closeModal(id) {
            document.getElementById(id).classList.add('hidden');
        }

        function showToast(text) {
            const toast = document.getElementById('toast');
            toast.innerText = text;
            toast.style.opacity = '1';
            setTimeout(() => { toast.style.opacity = '0'; }, 2000);
        }

        document.getElementById('searchInput').addEventListener('input', renderFoodList);
        
        // 啟動程式
        init();
    </script>
</body>
</html>
