<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H&K 的美食筆記 - 雲端同步版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            transition: background-color 0.3s ease;
        }
        .food-card {
            transition: all 0.2s ease;
        }
        .food-card:active {
            transform: scale(0.98);
        }
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .modal-overlay {
            backdrop-filter: blur(4px);
        }
    </style>
</head>
<body class="pb-24 bg-gray-50 dark:bg-zinc-900 text-gray-900 dark:text-zinc-100">

    <!-- Header -->
    <header class="bg-white dark:bg-zinc-800 shadow-sm sticky top-0 z-10 px-4 py-4 transition-colors">
        <div class="max-w-md mx-auto">
            <div class="flex justify-between items-center">
                <h1 class="text-2xl font-bold text-orange-600 flex items-center gap-2">
                    <i class="fas fa-cloud"></i> H&K 美食筆記
                </h1>
                <div class="flex items-center gap-2">
                    <div id="syncStatus" class="text-[10px] text-gray-400 font-bold bg-gray-100 dark:bg-zinc-700 px-2 py-1 rounded-full">
                        連線中...
                    </div>
                    <button onclick="toggleDarkMode()" class="text-gray-500 dark:text-zinc-400 hover:text-orange-600 p-2 text-xl">
                        <i id="themeIcon" class="fas fa-moon"></i>
                    </button>
                    <button onclick="openCategoryManager()" class="text-gray-500 dark:text-zinc-400 hover:text-orange-600 p-2">
                        <i class="fas fa-tags text-xl"></i>
                    </button>
                </div>
            </div>
            
            <div class="mt-4 relative">
                <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                <input type="text" id="searchInput" placeholder="搜尋雲端筆記..." 
                    class="w-full pl-10 pr-4 py-2 bg-gray-100 dark:bg-zinc-700 dark:text-white rounded-xl border-none focus:ring-2 focus:ring-orange-500 outline-none transition">
            </div>

            <div class="flex gap-2 mt-4 overflow-x-auto no-scrollbar py-1" id="categoryTabs"></div>
        </div>
    </header>

    <!-- 清單內容 -->
    <main class="max-w-md mx-auto p-4 space-y-4" id="foodList">
        <div id="loadingIndicator" class="text-center py-20 text-gray-400">
            <i class="fas fa-circle-notch fa-spin text-2xl mb-2"></i>
            <p>正在同步雲端資料...</p>
        </div>
    </main>

    <!-- 新增按鈕 -->
    <button onclick="openAddModal()" class="fixed bottom-6 right-6 w-14 h-14 bg-orange-600 text-white rounded-full shadow-lg flex items-center justify-center text-2xl z-20 hover:bg-orange-700 transition">
        <i class="fas fa-plus"></i>
    </button>

    <!-- 店家編輯/新增彈窗 -->
    <div id="foodModal" class="fixed inset-0 bg-black/50 hidden z-30 flex items-end sm:items-center justify-center p-0 sm:p-4 modal-overlay">
        <div class="bg-white dark:bg-zinc-800 w-full max-w-md rounded-t-3xl sm:rounded-2xl p-6 shadow-xl">
            <div class="flex justify-between items-center mb-4">
                <h2 id="modalTitle" class="text-xl font-bold text-gray-800 dark:text-zinc-100">新增美食店家</h2>
                <button onclick="closeModal('foodModal')" class="text-gray-400"><i class="fas fa-times"></i></button>
            </div>
            <input type="hidden" id="editId">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-zinc-400">店名</label>
                    <input type="text" id="nameInput" class="w-full mt-1 p-3 bg-gray-50 dark:bg-zinc-700 dark:text-white border-none rounded-xl outline-none focus:ring-2 focus:ring-orange-500">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-zinc-400">分類</label>
                        <select id="typeInput" class="w-full mt-1 p-3 bg-gray-50 dark:bg-zinc-700 dark:text-white border-none rounded-xl outline-none focus:ring-2 focus:ring-orange-500"></select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-zinc-400">評分</label>
                        <select id="ratingInput" class="w-full mt-1 p-3 bg-gray-50 dark:bg-zinc-700 dark:text-white border-none rounded-xl outline-none focus:ring-2 focus:ring-orange-500">
                            <option value="5">⭐⭐⭐⭐⭐</option>
                            <option value="4">⭐⭐⭐⭐</option>
                            <option value="3">⭐⭐⭐</option>
                            <option value="2">⭐⭐</option>
                            <option value="1">⭐</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-zinc-400">地址</label>
                    <input type="text" id="addressInput" class="w-full mt-1 p-3 bg-gray-50 dark:bg-zinc-700 dark:text-white border-none rounded-xl outline-none focus:ring-2 focus:ring-orange-500" placeholder="輸入詳細地址...">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-zinc-400">筆記心得</label>
                    <textarea id="noteInput" rows="3" class="w-full mt-1 p-3 bg-gray-50 dark:bg-zinc-700 dark:text-white border-none rounded-xl outline-none focus:ring-2 focus:ring-orange-500" placeholder="紀錄好吃的菜色..."></textarea>
                </div>
                <button onclick="saveFood()" id="saveBtn" class="w-full py-4 bg-orange-600 text-white rounded-xl font-bold shadow-md">儲存並同步至雲端</button>
            </div>
        </div>
    </div>

    <!-- 分類管理彈窗 -->
    <div id="categoryModal" class="fixed inset-0 bg-black/50 hidden z-40 flex items-center justify-center p-4 modal-overlay">
        <div class="bg-white dark:bg-zinc-800 w-full max-w-xs rounded-2xl p-6 shadow-xl">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-bold dark:text-zinc-100">管理分類</h2>
                <button onclick="closeModal('categoryModal')" class="text-gray-400"><i class="fas fa-times"></i></button>
            </div>
            <div class="space-y-3 mb-4 max-h-60 overflow-y-auto" id="categoryListContainer"></div>
            <div class="flex gap-2 mt-4">
                <input type="text" id="newCatInput" placeholder="新分類名稱" class="flex-1 p-2 bg-gray-50 dark:bg-zinc-700 dark:text-white rounded-lg outline-none text-sm">
                <button onclick="addCategory()" class="px-4 py-2 bg-orange-600 text-white rounded-lg text-sm">新增</button>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-24 left-1/2 -translate-x-1/2 bg-gray-800 dark:bg-orange-600 text-white px-6 py-2 rounded-full text-sm opacity-0 transition-all pointer-events-none z-50"></div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, addDoc, updateDoc, deleteDoc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

        // ==========================================
        // 1. 在此貼上你的 Firebase Config (從 Firebase 控制台取得)
        // ==========================================
        const firebaseConfig = {
  apiKey: "AIzaSyA_S1vEkcK359GRrJwjzLoRxS-LW_YpLRk",
  authDomain: "my-food-list-faf4a.firebaseapp.com",
  projectId: "my-food-list-faf4a",
  storageBucket: "my-food-list-faf4a.firebasestorage.app",
  messagingSenderId: "837318121616",
  appId: "1:837318121616:web:85644f8a3226812d3d6015",
  measurementId: "G-LD5LJQ9PXG"
};

        // 初始化
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // 此 ID 決定了資料存在資料庫的哪個位置，如果你想多人共用，請確保大家的 appId 相同
        const appId = "my-shared-food-list"; 

        // 全域狀態
        window.foods = [];
        window.categories = ["全部", "中式", "日式", "義式", "甜點", "咖啡廳"];
        window.currentCategory = '全部';
        window.userLocation = null;
        window.currentUser = null;

        // Firebase 認證
        const initAuth = async () => {
            try {
                await signInAnonymously(auth);
            } catch (err) {
                console.error("Auth Error:", err);
                document.getElementById('syncStatus').innerText = "連線失敗";
                document.getElementById('syncStatus').className = "text-[10px] text-red-500 font-bold bg-red-50 px-2 py-1 rounded-full";
            }
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                window.currentUser = user;
                document.getElementById('syncStatus').innerText = "雲端同步中";
                document.getElementById('syncStatus').className = "text-[10px] text-green-500 font-bold bg-green-50 px-2 py-1 rounded-full";
                setupDataListeners();
            }
        });

        // 監聽資料
        const setupDataListeners = () => {
            const foodsRef = collection(db, 'foods_data'); // 簡化路徑方便測試模式使用
            
            // 監聽店家
            onSnapshot(foodsRef, (snapshot) => {
                window.foods = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderFoodList();
                document.getElementById('loadingIndicator')?.remove();
            });

            // 監聽分類
            const catsRef = doc(db, 'settings', 'categories');
            onSnapshot(catsRef, (docSnap) => {
                if (docSnap.exists()) {
                    window.categories = docSnap.data().list;
                    renderCategories();
                } else {
                    // 初始化分類到雲端
                    setDoc(catsRef, { list: window.categories });
                }
            });
        };

        // 操作函數
        window.saveFood = async () => {
            const id = document.getElementById('editId').value;
            const data = {
                name: document.getElementById('nameInput').value.trim(),
                type: document.getElementById('typeInput').value,
                rating: document.getElementById('ratingInput').value,
                address: document.getElementById('addressInput').value.trim(),
                note: document.getElementById('noteInput').value.trim(),
                updatedAt: Date.now()
            };

            if (!data.name || !data.address) {
                showToast('店名與地址不能空白');
                return;
            }

            try {
                if (id) {
                    await updateDoc(doc(db, 'foods_data', id), data);
                    showToast('已更新');
                } else {
                    data.lat = 25.04 + (Math.random() - 0.5) * 0.1;
                    data.lng = 121.5 + (Math.random() - 0.5) * 0.1;
                    await addDoc(collection(db, 'foods_data'), data);
                    showToast('已新增');
                }
                closeModal('foodModal');
            } catch (e) { showToast('同步失敗'); }
        };

        window.deleteFood = async (id) => {
            if (!confirm('確定要從雲端刪除嗎？')) return;
            await deleteDoc(doc(db, 'foods_data', id));
            showToast('已刪除');
        };

        window.addCategory = async () => {
            const val = document.getElementById('newCatInput').value.trim();
            if (val && !window.categories.includes(val)) {
                const newList = [...window.categories, val];
                await setDoc(doc(db, 'settings', 'categories'), { list: newList });
                document.getElementById('newCatInput').value = '';
            }
        };

        window.deleteCategory = async (catName) => {
            const newList = window.categories.filter(c => c !== catName);
            await setDoc(doc(db, 'settings', 'categories'), { list: newList });
        };

        initAuth();
        getUserLocation();
    </script>

    <script>
        // UI 渲染與其他邏輯
        function getUserLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((position) => {
                    window.userLocation = { lat: position.coords.latitude, lng: position.coords.longitude };
                    renderFoodList();
                });
            }
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
            return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)));
        }

        function renderCategories() {
            const tabs = document.getElementById('categoryTabs');
            if (!tabs) return;
            tabs.innerHTML = window.categories.map(cat => `
                <button onclick="filterCategory('${cat}')" 
                    class="px-5 py-2 rounded-full whitespace-nowrap text-sm font-medium transition
                    ${window.currentCategory === cat ? 'bg-orange-600 text-white shadow-md' : 'bg-white dark:bg-zinc-800 text-gray-500 dark:text-zinc-400 border border-gray-100 dark:border-zinc-700'}">
                    ${cat}
                </button>
            `).join('');
            const typeInput = document.getElementById('typeInput');
            if (typeInput) typeInput.innerHTML = window.categories.filter(c => c !== '全部').map(cat => `<option value="${cat}">${cat}</option>`).join('');
        }

        function renderFoodList() {
            const list = document.getElementById('foodList');
            const search = document.getElementById('searchInput').value.toLowerCase();
            let filtered = window.foods.filter(f => f.name.toLowerCase().includes(search) || f.address.toLowerCase().includes(search));
            if (window.currentCategory !== '全部') filtered = filtered.filter(f => f.type === window.currentCategory);

            if (window.userLocation) {
                filtered = filtered.map(f => ({ ...f, dist: (f.lat && f.lng) ? calculateDistance(window.userLocation.lat, window.userLocation.lng, f.lat, f.lng) : 9999 })).sort((a, b) => a.dist - b.dist);
            } else {
                filtered.sort((a, b) => (b.updatedAt || 0) - (a.updatedAt || 0));
            }

            if (filtered.length === 0 && window.foods.length > 0) {
                list.innerHTML = `<div class="text-center py-20 text-gray-400">找不到相關店家</div>`;
                return;
            } else if (window.foods.length === 0) {
                return; // 等待 loading 消失
            }

            list.innerHTML = filtered.map(food => `
                <div class="food-card bg-white dark:bg-zinc-800 p-4 rounded-2xl shadow-sm border border-gray-50 dark:border-zinc-700 flex flex-col gap-3" onclick="openEditModal('${food.id}')">
                    <div class="flex justify-between items-start">
                        <div class="flex-1 overflow-hidden">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-[10px] px-2 py-0.5 bg-orange-100 dark:bg-orange-900/30 text-orange-600 dark:text-orange-400 rounded-md font-bold uppercase">${food.type}</span>
                                <span class="text-yellow-400 text-xs">${'⭐'.repeat(parseInt(food.rating))}</span>
                                ${food.dist && food.dist !== 9999 ? `<span class="text-[10px] text-gray-400"><i class="fas fa-walking"></i> ${food.dist.toFixed(1)} km</span>` : ''}
                            </div>
                            <h3 class="text-lg font-bold text-gray-800 dark:text-zinc-100 truncate">${food.name}</h3>
                        </div>
                        <button onclick="event.stopPropagation(); window.open('https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(food.address)}')" class="w-10 h-10 bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 rounded-full flex items-center justify-center">
                            <i class="fas fa-location-arrow"></i>
                        </button>
                    </div>
                    ${food.note ? `<p class="text-gray-500 dark:text-zinc-400 text-sm italic">「${food.note}」</p>` : ''}
                    <div class="flex justify-between items-center text-[11px] text-gray-400 pt-1 border-t border-gray-50 dark:border-zinc-700">
                        <span class="truncate"><i class="fas fa-map-marker-alt mr-1"></i>${food.address}</span>
                        <button onclick="event.stopPropagation(); window.deleteFood('${food.id}')" class="text-red-300 hover:text-red-500 p-1"><i class="fas fa-trash-alt"></i></button>
                    </div>
                </div>
            `).join('');
        }

        function toggleDarkMode() {
            document.documentElement.classList.toggle('dark');
            document.getElementById('themeIcon').className = document.documentElement.classList.contains('dark') ? 'fas fa-sun' : 'fas fa-moon';
        }

        function filterCategory(cat) { window.currentCategory = cat; renderCategories(); renderFoodList(); }
        function openAddModal() {
            document.getElementById('modalTitle').innerText = '新增雲端美食';
            document.getElementById('editId').value = '';
            document.getElementById('nameInput').value = '';
            document.getElementById('addressInput').value = '';
            document.getElementById('noteInput').value = '';
            document.getElementById('foodModal').classList.remove('hidden');
        }

        function openEditModal(id) {
            const food = window.foods.find(f => f.id === id);
            if (!food) return;
            document.getElementById('modalTitle').innerText = '編輯雲端資訊';
            document.getElementById('editId').value = food.id;
            document.getElementById('nameInput').value = food.name;
            document.getElementById('typeInput').value = food.type;
            document.getElementById('ratingInput').value = food.rating;
            document.getElementById('addressInput').value = food.address;
            document.getElementById('noteInput').value = food.note || '';
            document.getElementById('foodModal').classList.remove('hidden');
        }

        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        function openCategoryManager() { document.getElementById('categoryModal').classList.remove('hidden'); renderCategoryManager(); }
        function renderCategoryManager() {
            const container = document.getElementById('categoryListContainer');
            container.innerHTML = window.categories.filter(c => c !== '全部').map(cat => `
                <div class="flex justify-between items-center p-3 bg-gray-50 dark:bg-zinc-700/50 rounded-xl mb-2">
                    <span class="text-sm font-medium">${cat}</span>
                    <button onclick="window.deleteCategory('${cat}')" class="text-red-400"><i class="fas fa-minus-circle text-lg"></i></button>
                </div>
            `).join('');
        }
        function showToast(text) {
            const toast = document.getElementById('toast');
            toast.innerText = text; toast.style.opacity = '1';
            setTimeout(() => { toast.style.opacity = '0'; }, 2000);
        }
        document.getElementById('searchInput').addEventListener('input', renderFoodList);
    </script>
</body>
</html>

